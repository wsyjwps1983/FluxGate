# Semantic Router 功能增强实现计划

## 1. 核心功能分析与文档生成

### 1.1 当前系统架构
- **核心组件**：Route、BaseRouter、SemanticRouter、HybridRouter、LocalIndex
- **工作流程**：创建Route → 编码器向量化 → 向量存储索引 → 查询时向量化并匹配
- **当前限制**：依赖Siliconflow API，缺乏本地向量化，阈值调节不够灵活

### 1.2 核心功能描述文档
将生成一份详细的核心功能描述文档，包括：
- 系统架构图
- 核心组件说明
- 工作流程图
- API接口说明
- 使用示例

## 2. 本地向量化存储实现

### 2.1 集成faiss-cpu
- 替换当前的Siliconflow API依赖
- 实现基于faiss-cpu的本地向量索引
- 支持向量的高效存储和查询

### 2.2 向量与原始问题的双向映射
- 在索引中存储向量与原始问题的映射关系
- 实现向量到原始问题的反向查询
- 实现原始问题到向量的正向查询

### 2.3 自动更新路由
- 修改`add`方法，支持新增意图路由的自动更新
- 实现路由更新时的向量重新计算和索引更新

## 3. HybridRouter 自定义阈值支持

### 3.1 路由级别的阈值设置
- 增强`Route`类，支持为每个路由设置独立的阈值
- 实现不同路由类型的阈值差异化管理

### 3.2 HybridRouter 阈值优化
- 修改`_set_score_threshold`方法，支持基于路由类型的阈值计算
- 实现阈值的动态调整和优化

## 4. FastAPI 服务实现

### 4.1 API 设计
- `/predict`：接收单个问题，返回意图类型、是否命中、相似度得分
- `/routes`：管理路由（增删改查）
- `/health`：健康检查

### 4.2 服务实现
- 使用FastAPI框架创建服务
- 集成路由预测功能
- 实现请求和响应的验证
- 添加API文档（Swagger UI）

## 5. 测试与验证

### 5.1 单元测试
- 测试本地向量化功能
- 测试向量与原始问题的双向映射
- 测试自定义阈值功能

### 5.2 集成测试
- 测试FastAPI服务的完整流程
- 测试路由自动更新功能
- 测试HybridRouter的混合查询功能

## 6. 实现步骤

1. **生成核心功能描述文档**
2. **实现本地向量化存储**
3. **实现向量与原始问题的双向映射**
4. **增强HybridRouter的自定义阈值支持**
5. **实现FastAPI服务**
6. **编写测试用例**
7. **进行集成测试和验证**

## 7. 预期成果

- 减少对外部API的依赖，降低成本
- 提高系统的响应速度和可靠性
- 增强系统的灵活性，支持自定义阈值
- 提供易用的API服务，方便集成到其他系统
- 支持向量与原始问题的双向查询，便于调试和分析